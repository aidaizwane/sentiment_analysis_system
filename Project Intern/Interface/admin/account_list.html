{% extends "admin/base_admin.html" %}
{% block title %}User Account List{% endblock %}

{% block content %}
  <h1 class="admin-title">User Account List</h1>

  
  <!-- Add User (no second search bar) -->
<div class="ua-search-wrap ua-add-only">
  <button id="btnOpenAddUser" type="button" class="ua-add-btn">+ Add User</button>
</div>

  <!-- ‚úÖ Add User Overlay (same concept as deleteOverlay) -->
  <div id="addUserOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:9999;">
    <div style="width:520px; max-width:92vw; background:#fff; border-radius:12px; padding:22px; margin:14vh auto; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <div style="font-size:18px; font-weight:800; margin-bottom:14px; text-align:center;">Create User Account</div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label style="font-size:12px; color:#666;">Username</label>
          <input id="auUsername" class="ua-field" type="text" placeholder="e.g. user2">
        </div>
        <div>
          <label style="font-size:12px; color:#666;">Role</label>
          <select id="auRole" class="ua-field">
            <option value="USER" selected>USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>

        <div style="grid-column:1 / -1;">
          <label style="font-size:12px; color:#666;">Full Name</label>
          <input id="auFullName" class="ua-field" type="text" placeholder="e.g. Haezel">
        </div>

        <div style="grid-column:1 / -1;">
          <label style="font-size:12px; color:#666;">Email</label>
          <input id="auEmail" class="ua-field" type="email" placeholder="e.g. test@gmail.com">
        </div>

        <div style="grid-column:1 / -1;">
          <label style="font-size:12px; color:#666;">Temporary Password</label>
          <div style="position:relative;">
  <input id="auPassword"
         class="ua-field"
         type="password"
         placeholder="min 8 characters"
         style="padding-right:42px;">

  <button type="button"
          id="auTogglePwd"
          style="
            position:absolute;
            right:10px;
            top:50%;
            transform:translateY(-50%);
            border:none;
            background:transparent;
            cursor:pointer;
            font-size:14px;
            opacity:.7;
          ">
    üëÅ
  </button>
</div>

          <div style="font-size:11px; color:#888; margin-top:6px;">
            User can update this later in the user portal.
          </div>
        </div>
      </div>

      <div id="auError" style="display:none; margin-top:12px; font-size:12px; color:#b00020; text-align:center;"></div>

      <div style="display:flex; justify-content:center; gap:14px; margin-top:16px;">
        <button id="btnCancelAddUser" style="background:#222; color:#fff; border:none; padding:10px 22px; border-radius:8px; cursor:pointer;">Cancel</button>
        <button id="btnCreateAddUser" style="background:#28a745; color:#fff; border:none; padding:10px 22px; border-radius:8px; cursor:pointer;">Create</button>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="ua-search-wrap">
    <input id="searchInput" class="ua-search" type="text" placeholder="Search username, name or ID">
    <span class="ua-search-icon">üîç</span>
  </div>

  <!-- Table Card -->
  <div class="ua-card">
    <table class="ua-table">
      <thead>
        <tr>
          <th class="col-id">ID</th>
          <th class="col-username">Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th class="col-role">Role</th>
          <th class="col-action"></th>
        </tr>
      </thead>

      <tbody id="accountsTbody">
        <!-- placeholder rows (same as screenshot) -->
        {% for _ in range(10) %}
        <tr>
          <td class="muted"></td>
          <td class="muted"></td>
          <td class="muted"></td>
          <td class="muted"></td>
          <td class="actions">
            <span class="icon">‚úé</span>
            <span class="icon">üóë</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="ua-pagination">
    <span class="page-chip active">1</span>
    <span class="page-chip">2</span>
    <span class="page-chip">3</span>
    <span class="page-chip dots">‚Ä¶</span>
    <span class="page-chip">67</span>
    <span class="page-chip">68</span>
  </div>

  <div id="deleteOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:9999;">
  <div style="width:420px; max-width:90vw; background:#fff; border-radius:12px; padding:22px; margin:18vh auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); text-align:center;">
    <div id="deleteStepConfirm">
      <div style="margin:10px 0 18px; color:#666;">Continue Delete?</div>
      <div style="display:flex; justify-content:center; gap:14px;">
        <button id="btnCancelDelete" style="background:#222; color:#fff; border:none; padding:10px 22px; border-radius:8px; cursor:pointer;">Cancel</button>
        <button id="btnConfirmDelete" style="background:#28a745; color:#fff; border:none; padding:10px 22px; border-radius:8px; cursor:pointer;">Confirm</button>
      </div>
    </div>

    <div id="deleteStepDone" style="display:none;">
      <div style="font-size:40px; margin:6px 0;">‚úÖ</div>
      <div style="margin:10px 0 18px; color:#666;">Successfully Delete!</div>
      <button id="btnDoneDelete" style="background:#222; color:#fff; border:none; padding:10px 28px; border-radius:8px; cursor:pointer;">Done</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>

/* Button-only row uses the same wrap spacing but no input */
.ua-search-wrap.ua-add-only{
  height: 44px;            /* same height as input row */
}

/* Place Add User button in a clean spot on the right */
.ua-search-wrap.ua-add-only .ua-add-btn{
  right: 16px;             /* align like the search icon did */
}

  
.ua-title{
  margin: 0 0 18px;
  font-size: 34px;          /* same visual size */
  font-weight: 700;         /* semi-bold, not heavy */
  color: #2b2b2b;
  text-shadow: 0 1px 0 rgba(0,0,0,0.08);
}

  /* Search bar */
  .ua-search-wrap{
    position: relative;
    width: 100%;
    margin: 0 0 18px;
  }

  .ua-search{
    width: 100%;
    height: 44px;
    border-radius: 999px;
    border: 1px solid #d9d9d9;
    padding: 0 44px 0 18px;
    font-size: 14px;
    background: #fff;
    box-shadow: 0 6px 14px rgba(0,0,0,0.14);
    outline: none;
  }
  .ua-search::placeholder{ color: #a7a7a7; }

  .ua-search-icon{
    position:absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    opacity: .75;
    font-size: 15px;
    pointer-events:none;
  }

    /* ‚úÖ Add User button inside search bar (no layout change) */
  .ua-add-btn{
    position:absolute;
    right: 16px;            /* keep alaignment */
    top: 50%;
    transform: translateY(-50%);
    height: 30px;
    padding: 0 12px;
    border: none;
    border-radius: 999px;
    background:#2a2a2a;
    color:#fff;
    font-size: 12px;
    font-weight: 700;
    cursor:pointer;
    box-shadow: 0 8px 16px rgba(0,0,0,0.18);
  }

  /* Make the Add User row match the table card width so its right edge aligns */
.ua-search-wrap.ua-add-only{
  width: 105%;
}

  .ua-add-btn:hover{ opacity: .92; }

  /* ‚úÖ inputs inside modal */
  .ua-field{
    width:100%;
    height: 40px;
    border-radius: 10px;
    border: 1px solid #d9d9d9;
    padding: 0 12px;
    font-size: 13px;
    outline:none;
  }


  /* Table card */
  .ua-card{
    background:#fff;
    width: 105%;
    border-radius: 10px;
    border: 1px solid #e4e4e4;
    box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    overflow: hidden;
  }

  .ua-table{
    width:100%;
    border-collapse: collapse;
  }

  .ua-table thead th{
    padding: 14px 14px;
    font-size: 12px;
    font-weight: 800;
    color:#2b2b2b;
    text-align: center;
    border-bottom: 2px solid #a9a9a9; /* thicker line like screenshot */
  }

  .ua-table tbody td{
    padding: 10px 14px;
    font-size: 12px;
    color:#4a4a4a;
    border-bottom: 1px solid #cfcfcf;
  }

  .ua-table tbody tr:last-child td{
    border-bottom: none;
  }

  .col-id{ width: 100px; }
  .col-role{ width: 140px; }
  .col-action{ width: 90px; }

  .muted{ color:#6a6a6a; }

  .actions{
    text-align:right;
    white-space:nowrap;
    padding-right: 18px;
  }

  .icon{
    display:inline-block;
    margin-left: 10px;
    opacity:.70;
    cursor: default; /* placeholder */
    font-size: 14px;
  }

  /* Pagination bottom-right */
  .ua-pagination{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap: 14px;
    margin-top: 16px;
    padding-right: 6px;
  }

  .page-chip{
    font-size: 12px;
    color:#3a3a3a;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity: .85;
  }

  .page-chip.active{
    background:#2a2a2a;
    color:#fff;
    box-shadow: 0 10px 18px rgba(0,0,0,0.25);
    opacity: 1;
  }

  .page-chip.dots{
    width:auto;
    padding: 0 6px;
  }

  /* Ensure consistent bordered inputs inside Add User modal */
#addUserOverlay .ua-field{
  box-sizing: border-box;
  border-radius: 12px;
  border: 1px solid #ddd;
  background: #fff;
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

</style>
{% endblock %}

{% block extra_js %}
<script>
  console.log("Account list JS loaded");

  const tbody = document.querySelector("#accountsTbody");
  const searchInput = document.querySelector("#searchInput");

  const overlay = document.getElementById("deleteOverlay");
  const stepConfirm = document.getElementById("deleteStepConfirm");
  const stepDone = document.getElementById("deleteStepDone");
  const btnCancel = document.getElementById("btnCancelDelete");
  const btnConfirm = document.getElementById("btnConfirmDelete");
  const btnDone = document.getElementById("btnDoneDelete");

  let currentDeleteId = null;

    // ‚úÖ Add User modal elements
  const addOverlay = document.getElementById("addUserOverlay");
  const btnOpenAdd = document.getElementById("btnOpenAddUser");
  const btnCancelAdd = document.getElementById("btnCancelAddUser");
  const btnCreateAdd = document.getElementById("btnCreateAddUser");
  const auError = document.getElementById("auError");

  const auUsername = document.getElementById("auUsername");
  const auFullName = document.getElementById("auFullName");
  const auEmail = document.getElementById("auEmail");
  const auPassword = document.getElementById("auPassword");
  const auRole = document.getElementById("auRole");

  function openAddUser(){
    if (!addOverlay) return;
    auError.style.display = "none";
    auError.textContent = "";

    // clear fields
    auUsername.value = "";
    auFullName.value = "";
    auEmail.value = "";
    auPassword.value = "";
    auRole.value = "USER";

    addOverlay.style.display = "block";
    setTimeout(() => auUsername.focus(), 50);
  }

  function closeAddUser(){
    if (!addOverlay) return;
    addOverlay.style.display = "none";
  }

  if (btnOpenAdd) btnOpenAdd.addEventListener("click", openAddUser);
  if (btnCancelAdd) btnCancelAdd.addEventListener("click", closeAddUser);

  // click outside card to close
  if (addOverlay) addOverlay.addEventListener("click", (e) => {
    if (e.target === addOverlay) closeAddUser();
  });

  if (btnCreateAdd) btnCreateAdd.addEventListener("click", async () => {
    auError.style.display = "none";
    auError.textContent = "";

    const payload = {
      username: (auUsername.value || "").trim(),
      full_name: (auFullName.value || "").trim(),
      email: (auEmail.value || "").trim(),
      password: (auPassword.value || ""),
      role: (auRole.value || "USER")
    };

    // small frontend validation
    if (!payload.username || !payload.full_name || !payload.email || !payload.password) {
      auError.textContent = "Please fill in all fields.";
      auError.style.display = "block";
      return;
    }
    if (payload.password.length < 8) {
      auError.textContent = "Password must be at least 8 characters.";
      auError.style.display = "block";
      return;
    }

    try {
      const res = await fetch("/api/admin/accounts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      if (!data.ok) {
        auError.textContent = data.error || "Failed to create user.";
        auError.style.display = "block";
        return;
      }

      closeAddUser();
      await loadAccounts(); // refresh table
    } catch (err) {
      auError.textContent = "Network error. Please try again.";
      auError.style.display = "block";
    }
  });

  function formatAuditTooltip(row) {
  const at = row.password_updated_at ? new Date(row.password_updated_at) : null;
  const atText = at ? at.toLocaleString() : "Not available";
  const byText = row.password_updated_by || "Not available";
  return `Last password update: ${atText}\nUpdated by: ${byText}`;
}


  async function loadAccounts() {
    const q = (searchInput?.value || "").trim();
    const res = await fetch(`/api/admin/accounts?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if (!data.ok) return;

    tbody.innerHTML = "";

    for (const row of data.rows) {
      const tr = document.createElement("tr");
      const tip = formatAuditTooltip(row).replace(/"/g, "&quot;");

tr.innerHTML = `
  <td title="${tip}">${row.id ?? ""}</td>
  <td title="${tip}">${row.username ?? ""}</td>
  <td title="${tip}">${row.full_name ?? ""}</td>
  <td title="${tip}">${row.email ?? ""}</td>
  <td title="${tip}">${row.role ?? ""}</td>
  <td class="actions">
    <span class="icon btn-edit" data-id="${row.id}" title="${tip}">‚úé</span>
    <span class="icon btn-delete" data-id="${row.id}" title="${tip}">üóë</span>
  </td>
`;

      tbody.appendChild(tr);
    }

    document.querySelectorAll(".btn-edit").forEach(btn => {
    btn.addEventListener("click", () => {
      window.location.href = `/admin/accounts/edit/${btn.dataset.id}`;
    });
  });

    document.querySelectorAll(".btn-delete").forEach(btn => {
      btn.addEventListener("click", () => openDelete(btn.dataset.id));
    });
  }

  function openDelete(id) {
    currentDeleteId = id;
    stepConfirm.style.display = "block";
    stepDone.style.display = "none";
    overlay.style.display = "block";
  }

  function closeDelete() {
    overlay.style.display = "none";
    currentDeleteId = null;
  }

  // ‚úÖ add null checks (so it never crashes)
  if (btnCancel) btnCancel.addEventListener("click", closeDelete);

  if (btnConfirm) btnConfirm.addEventListener("click", async () => {
    if (!currentDeleteId) return;
    const res = await fetch(`/api/admin/accounts/${currentDeleteId}`, { method: "DELETE" });
    const data = await res.json();

    if (data.ok) {
      stepConfirm.style.display = "none";
      stepDone.style.display = "block";
      await loadAccounts();
    }
  });

  if (btnDone) btnDone.addEventListener("click", closeDelete);

  if (searchInput) {
    let t = null;
    searchInput.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(loadAccounts, 250);
    });
  }

  loadAccounts();

  const auTogglePwd = document.getElementById("auTogglePwd");

if (auTogglePwd) {
  auTogglePwd.addEventListener("click", () => {
    auPassword.type =
      auPassword.type === "password" ? "text" : "password";
  });
}

</script>
{% endblock %}



